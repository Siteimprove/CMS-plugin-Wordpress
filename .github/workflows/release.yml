name: Create Release
on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Archive Release
        uses: Siteimprove/zip-release@main
        with:
          type: 'zip'
          filename: 'siteimprove.zip'
          exclusions: '*.git* /*node_modules/* .editorconfig .gitignore phpcs.xml README.md /*.github/*'
      - name: Upload Release
        uses: Siteimprove/release-action@v1
        with:
          artifacts: 'siteimprove.zip'
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        include:
          # Dry run mode
          - tag_pattern: '-dry-run'
            mode: 'dry-run'
            dry_run: true
            test_mode: false
          # Test mode
          - tag_pattern: '-test'
            mode: 'test'
            dry_run: false
            test_mode: true
          # Production mode
          - tag_pattern: 'production'
            mode: 'production'
            dry_run: false
            test_mode: false
    if: |
      (contains(github.ref_name, matrix.tag_pattern) && matrix.tag_pattern != 'production') ||
      (!contains(github.ref_name, '-test') && !contains(github.ref_name, '-dry-run') && matrix.tag_pattern == 'production')
    steps:
      - uses: actions/checkout@master
      - name: Deploy to WordPress Marketplace (${{ matrix.mode }})
        uses: ./.github/actions/deploy-to-wordpress
        with:
          version: ${{ github.ref_name }}
          plugin-slug: ${{ vars.WP_PLUGIN_SLUG || 'siteimprove' }}
          svn-username: ${{ matrix.mode == 'test' && secrets.TEST_SVN_USERNAME || secrets.WP_SVN_USERNAME }}
          svn-password: ${{ matrix.mode == 'test' && secrets.TEST_SVN_PASSWORD || secrets.WP_SVN_PASSWORD }}
          svn-url: ${{ matrix.mode == 'test' && vars.TEST_SVN_URL || vars.WP_SVN_URL || 'https://plugins.svn.wordpress.org/siteimprove/' }}
          assets-dir: ${{ vars.WP_ASSETS_DIR || 'wordpress-assets' }}
          dry-run: ${{ matrix.dry_run }}
          test-mode: ${{ matrix.test_mode }}
